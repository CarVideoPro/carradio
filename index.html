<!DOCTYPE html>
<html lang="tr">
<head>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Video Pro Radyo</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  
  <style>
    :root {
        --player-height: 55px;
        --category-bar-height: 40px;
    }

    /* TEMA RENK DEÄÄ°ÅKENLERÄ° */
    [data-theme='default'] {
        --bg-primary: #000; --bg-secondary: #121212; --bg-tertiary: #1e1e1e; --bg-hover: #2c2c2c;
        --border-color: #333; --accent-color: #3366cc; --accent-color-darker: #252a3a;
        --text-primary: #fff; --text-secondary: #aaa; --favorite-color: #ffd700; 
    }
    [data-theme='forest'] {
        --bg-primary: #0a0a0a; --bg-secondary: #1a2e24; --bg-tertiary: #2d4036; --bg-hover: #3c5246;
        --border-color: #444; --accent-color: #4CAF50; --accent-color-darker: #388E3C;
        --text-primary: #e0e0e0; --text-secondary: #b0b0b0; --favorite-color: #ffeb3b;
    }
    [data-theme='royal'] {
        --bg-primary: #0d0c1d; --bg-secondary: #1c1a3a; --bg-tertiary: #2e2c5b; --bg-hover: #3c3a6d;
        --border-color: #4a477a; --accent-color: #9C27B0; --accent-color-darker: #7B1FA2;
        --text-primary: #f3e5f5; --text-secondary: #ce93d8; --favorite-color: #fdd835;
    }
    [data-theme='sunset'] {
        --bg-primary: #1b120f; --bg-secondary: #3d2c26; --bg-tertiary: #5d4037; --bg-hover: #6d4c41;
        --border-color: #4e342e; --accent-color: #FF5722; --accent-color-darker: #E64A19;
        --text-primary: #fff3e0; --text-secondary: #ffccbc; --favorite-color: #ffc107;
    }
    [data-theme='steel'] {
        --bg-primary: #121212; --bg-secondary: #222222; --bg-tertiary: #333333; --bg-hover: #444444;
        --border-color: #555; --accent-color: #757575; --accent-color-darker: #616161;
        --text-primary: #f5f5f5; --text-secondary: #bdbdbd; --favorite-color: #f5f5f5;
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0; height: 100%; background: var(--bg-primary); font-family: sans-serif; overflow: hidden;
      color: var(--text-primary);
      font-size: 14px;
    }
    #app {
      display: flex; flex-direction: column; height: 100%;
      padding-bottom: calc(var(--player-height) + var(--category-bar-height));
    }
    #main {
      display: flex; flex: 1; overflow: hidden;
    }
    
    #channels {
      flex: 0 0 260px;
      background: var(--bg-secondary);
      border-right: 2px solid var(--border-color);
      overflow-y: auto;
      padding: 8px;
      display: flex; flex-direction: column; gap: 6px;
    }
    
    /* ANA GÃ–RÃœNÃœM ALANI */
    #previewArea {
        flex: 1; display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        background: var(--bg-primary); overflow: hidden; position: relative;
    }
    #previewPlaceholder {
        padding: 20px; display: flex; flex-direction: column;
        align-items: center; justify-content: center; text-align: center;
        gap: 15px; color: #555; height: 100%; cursor: default; z-index: 1;
    }
    #previewPlaceholder h2 { font-size: 1.5em; }
    #previewPlaceholder p { font-size: 1em; }
    
    #main-logo-display {
        width: 200px; height: 200px; border-radius: 50%;
        object-fit: contain; background-color: rgba(255,255,255,0.05);
        border: 4px solid var(--bg-tertiary);
        box-shadow: 0 5px 25px rgba(0,0,0,0.3);
        display: none; z-index: 2; margin-bottom: 30px;
    }

    #main-analyzer-display {
        display: none; flex-direction: column;
        gap: 10px; z-index: 2; transform: scale(1.2);
    }
    .analyzer-channel {
        display: flex; justify-content: center;
        align-items: flex-end; height: 60px; gap: 5px;
    }
    .analyzer-bar {
        width: 8px; background-color: var(--accent-color);
        border-radius: 2px;
        animation: analyzer-wave 1.5s infinite ease-in-out alternate;
    }
    #previewArea.is-playing #previewPlaceholder { display: none; }
    #previewArea.is-playing #main-logo-display { display: block; }
    #previewArea.is-playing #main-analyzer-display { display: flex; }
    
    @keyframes analyzer-wave {
        0% { height: 2%; opacity: 0.3; }
        100% { height: 100%; opacity: 1; }
    }


    #audio-player { display: none; }
    
    /* ALT KATEGORÄ° Ã‡UBUÄU */
    #groups {
        position: fixed; bottom: var(--player-height); left: 0; width: 100%; height: var(--category-bar-height);
        background: var(--bg-secondary); border-top: 1px solid var(--border-color);
        display: flex; overflow-x: auto; z-index: 1000;
        scrollbar-width: thin; scrollbar-color: var(--accent-color) var(--bg-secondary);
    }
    #groups::-webkit-scrollbar { height: 6px; }
    #groups::-webkit-scrollbar-track { background: var(--bg-secondary); }
    #groups::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 10px; }

    .group {
      padding: 0 18px; cursor: pointer; background: transparent;
      border-right: 1px solid var(--border-color);
      line-height: var(--category-bar-height);
      white-space: nowrap; flex-shrink: 0;
      transition: background-color 0.2s;
    }
    .group:hover, .group.active {
      background: var(--accent-color);
    }

    /* KANAL LÄ°STESÄ° Ã–ÄESÄ° */
    .channel {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg-tertiary);
      border-radius: 6px; padding: 8px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .channel-info {
        flex-grow: 1; cursor: pointer; display: flex;
        align-items: center; gap: 8px; min-width: 0; 
    }
    .channel-info > div { min-width: 0; }
    .channel-info > div > div:first-child {
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .channel:hover { background: var(--bg-hover); }
    .channel.active { border-color: var(--accent-color); background: var(--accent-color-darker); }
    .channel img { width: 38px; height: 38px; object-fit: contain; flex-shrink: 0; }
    
    .fav-btn {
        font-size: 22px; cursor: pointer; padding: 5px;
        color: var(--text-secondary);
        transition: color 0.2s, transform 0.2s;
        -webkit-user-select: none; user-select: none;
        flex-shrink: 0; 
    }
    .fav-btn:hover { transform: scale(1.2); }
    .fav-btn.favorited { color: var(--favorite-color); }

    /* EN ALT PLAYER Ã‡UBUÄU */
    #playerContainer {
      position: fixed; bottom: 0; left: 0; width: 100%; height: var(--player-height); background: var(--bg-secondary);
      display: flex; z-index: 999; align-items: center; padding: 0 15px;
      border-top: 2px solid var(--border-color);
      justify-content: space-between;
      gap: 20px;
    }
    
    .player-info { 
        display: flex; 
        align-items: center; 
        gap: 12px;
        min-width: 0; 
        flex-basis: 250px;
        flex-grow: 1; 
        flex-shrink: 1;
    }
    
    /* 3D Kayan YazÄ± Konteyneri */
    .player-text { 
        flex-grow: 1;
        flex-shrink: 1;
        min-width: 0; 
        text-align: left; 
        overflow: hidden; 
        white-space: nowrap;
        background-color: rgba(0,0,0,0.25); 
        border-radius: 6px;
        border: 1px solid rgba(0,0,0,0.3);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
    }
    
    /* 3D Kayan YazÄ± Stili */
    .player-text .title { 
        display: inline-block; 
        white-space: nowrap;
        will-change: transform;
        padding: 8px 0; 
        animation: marquee-scroll 20s linear infinite;
        animation-play-state: paused; 
        font-size: 1.1em;
        font-weight: bold;
        color: var(--text-primary);
        text-shadow: 0 1px 1px rgba(0,0,0,0.7),
                     0 0 10px var(--accent-color);
    }
    
    /* OynatÄ±cÄ± Ã§alarken animasyonu baÅŸlat */
    #playerContainer.playing .player-text .title {
        animation-play-state: running;
    }
    
    /* JS'nin ekleyeceÄŸi kopyalanmÄ±ÅŸ iÃ§erik iÃ§in stil */
    .player-text .title span {
        display: inline-block;
        padding-right: 50px; /* Tekrarlar arasÄ± boÅŸluk */
    }
    
    /* Kayan YazÄ± Keyframes */
    @keyframes marquee-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); } 
    }


    /* PLAYER KONTROLLERÄ° */
    .player-controls { 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        flex-grow: 1; 
        flex-shrink: 0; 
        justify-content: center;
    }

    .control-btn {
      background: var(--bg-tertiary); color: var(--text-primary); 
      border: 1px solid var(--border-color);
      border-bottom: 3px solid var(--border-color);
      font-size: 14px; font-weight: bold;
      border-radius: 8px; cursor: pointer;
      height: 38px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.1s ease-in-out;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      visibility: hidden;
    }
    .control-btn#play-pause-btn { width: 45px; padding: 0; }
    .control-btn#play-pause-btn svg { width: 24px; height: 24px; fill: currentColor; }
    .hidden { display: none; }
    
    .control-btn:hover { 
        background: var(--bg-hover); transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }
    .control-btn:active {
        transform: translateY(1px); border-bottom-width: 1px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    /* TEMA SEÃ‡Ä°CÄ° */
    #themeSelector {
        display: flex; align-items: center; gap: 8px;
        flex-shrink: 0;
    }
    .theme-swatch {
        width: 20px; height: 20px; border-radius: 50%;
        cursor: pointer; border: 2px solid var(--border-color);
        transition: transform 0.2s, border-color 0.2s;
    }
    .theme-swatch:hover { transform: scale(1.1); }
    .theme-swatch.active {
        border-color: var(--text-primary);
        box-shadow: 0 0 5px var(--text-primary);
    }
    
    /* ZOOM KONTROLLERÄ° */
    .zoom-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: 15px;
        flex-shrink: 0;
    }
    .zoom-controls button {
        background-color: #5A5A6A;
        color: var(--text-primary);
        border: 1px solid rgba(0,0,0,0.2);
        border-top-color: rgba(255,255,255,0.1);
        width: 44px; 
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
        box-shadow: 0 3px 5px rgba(0,0,0,0.2), 
                    inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .zoom-controls button:hover { background-color: #6B6B7B; }
    .zoom-controls button:active {
        background-color: #505060;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        transform: translateY(1px);
    }
    .zoom-controls button svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }


    /* Mobil UyumluluÄŸu */
    @media (max-width: 768px) {
        #channels { flex: 0 0 200px; }
        .control-btn { padding: 0 10px; font-size: 12px; }
        .control-btn#play-pause-btn { width: 38px; padding: 0; }
        .player-info { gap: 8px; flex-basis: 150px; }
        .player-text .title { font-size: 0.9em; }
        
        .zoom-controls { display: none; } 
        
        #main-logo-display { width: 120px; height: 120px; margin-bottom: 20px; }
        #main-analyzer-display { transform: scale(0.8); }
    }
  </style>
</head>
<body data-theme="default">

  <div id="app">
    <div id="main">
      <div id="channels"></div>
      
      <div id="previewArea">
        <div id="previewPlaceholder">
          <h1> ğŸ“» Car Video Pro Radyo ğŸ“»</h1>
          <h2> ğŸ“ Ä°letiÅŸim : Telegram : t.me/car_video_pro ğŸ“</h2>
          <p>âœ”ï¸ LÃ¼tfen bir kategori seÃ§ip radyo kanalÄ±na tÄ±klayÄ±nÄ±z. âœ”ï¸</p>
        </div>
        
        <img id="main-logo-display" src="" alt="Radyo Logosu">
        
        <div id="main-analyzer-display">
            <div class="analyzer-channel" id="analyzer-1"></div>
            <div class="analyzer-channel" id="analyzer-2"></div>
        </div>
        
      </div>
    </div>
  </div>

  <div id="groups"></div>

  <div id="playerContainer">
    <div class="player-info">
      <div class="player-text">
        <div class="title" id="player-channel-name"></div>
      </div>
    </div>
    
    <div class="player-controls">
      <button class="control-btn" id="prev-btn" onclick="changeChannel(-1)">â—„ Geri</button>
      <button class="control-btn" id="play-pause-btn" aria-label="Play/Pause">
        <svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
        <svg id="pause-icon" class="hidden" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
      </button>
      <button class="control-btn" id="next-btn" onclick="changeChannel(1)">Ä°leri â–º</button>
    </div>
    
    <div style="display: flex; align-items: center; flex-shrink: 0;">
        <div id="themeSelector"></div>
        <div class="zoom-controls">
            <button id="zoom-out-btn" aria-label="KÃ¼Ã§Ã¼lt" title="KÃ¼Ã§Ã¼lt">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z"></path></svg>
            </button>
            <button id="zoom-in-btn" aria-label="BÃ¼yÃ¼t" title="BÃ¼yÃ¼t">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zm.5-7H9v2H7v1h2v2h1v-2h2V9h-2V7z"></path></svg>
            </button>
        </div>
    </div>

  </div>

  <audio id="audio-player"></audio>


  <script>
    const CATEGORIES = ["Favorilerim", "En Ã‡ok Dinlenenler", "PopÃ¼ler Radyolar", "TÃ¼rkÃ§e POP", "Arabesk Damar", "Haber", "Spor", "Dini", "DiÄŸer"];
    const DEFAULT_SCROLL_TEXT = "Car Video Pro EÄŸlencenin Adresi";

    const G_UI = {
        groups: document.getElementById("groups"),
        channels: document.getElementById("channels"),
        preview: {
            area: document.getElementById("previewArea"),
            placeholder: document.getElementById("previewPlaceholder"),
            mainLogo: document.getElementById("main-logo-display"),
            mainAnalyzer1: document.getElementById("analyzer-1"),
            mainAnalyzer2: document.getElementById("analyzer-2"),
        },
        player: { 
            container: document.getElementById("playerContainer"), 
            channelName: document.getElementById("player-channel-name"),
            controls: document.querySelectorAll('.control-btn') 
        },
        themeSelector: document.getElementById("themeSelector"),
        audioPlayer: document.getElementById("audio-player"),
        playPauseBtn: document.getElementById("play-pause-btn"),
        playIcon: document.getElementById("play-icon"),
        pauseIcon: document.getElementById("pause-icon"),
        zoomInBtn: document.getElementById("zoom-in-btn"),
        zoomOutBtn: document.getElementById("zoom-out-btn"),
        htmlElement: document.documentElement
    };
    
    // TEMA FonksiyonlarÄ± (DeÄŸiÅŸiklik yok)
    const themes = {
        'default': { name: 'VarsayÄ±lan', color: '#3366cc' }, 'forest': { name: 'Orman', color: '#4CAF50' }, 'royal': { name: 'Kraliyet', color: '#9C27B0' },
        'sunset': { name: 'GÃ¼n BatÄ±mÄ±', color: '#FF5722' }, 'steel': { name: 'Ã‡elik', color: '#757575' }
    };
    function applyTheme(themeName) {
        document.body.dataset.theme = themeName;
        localStorage.setItem('iptvTheme', themeName); 
        document.querySelectorAll('.theme-swatch').forEach(swatch => swatch.classList.toggle('active', swatch.dataset.theme === themeName));
    }
    function createThemeSelector() {
        for (const [key, theme] of Object.entries(themes)) {
            const swatch = document.createElement('div');
            swatch.className = 'theme-swatch'; swatch.dataset.theme = key; swatch.title = theme.name;
            swatch.style.backgroundColor = theme.color; swatch.onclick = () => applyTheme(key);
            G_UI.themeSelector.appendChild(swatch);
        }
    }
    
    // Global DeÄŸiÅŸkenler
    let hls;
    let allChannelsMap = new Map(); 
    let currentChannelList = []; 
    let currentChannelIndex = -1; 
    let activeGroupName = ''; 
    
    // Zoom DeÄŸiÅŸkenleri
    const ZOOM_KEY = 'carRadioZoomLevel';
    const ZOOM_STEP = 0.05;
    const MIN_ZOOM = 0.7;
    const MAX_ZOOM = 1.3;
    let currentZoom = 1.0;

    // --- Zoom FonksiyonlarÄ± (DeÄŸiÅŸiklik yok) ---
    const applyZoom = (zoomLevel) => { G_UI.htmlElement.style.zoom = zoomLevel; };
    const updateZoom = (newZoom) => {
        currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoom));
        applyZoom(currentZoom);
        localStorage.setItem(ZOOM_KEY, currentZoom);
    };
    const loadSavedZoom = () => {
        const savedZoom = localStorage.getItem(ZOOM_KEY);
        if (savedZoom) {
            currentZoom = parseFloat(savedZoom);
            applyZoom(currentZoom);
        }
    };

    // --- Favori & Dinleme FonksiyonlarÄ± (DeÄŸiÅŸiklik yok) ---
    function getFavorites() { return JSON.parse(localStorage.getItem('favoriteRadios') || '[]'); }
    function saveFavorites(favs) { localStorage.setItem('favoriteRadios', JSON.stringify(favs)); }
    function getListenCounts() { return JSON.parse(localStorage.getItem('radioListenCounts') || '{}'); }
    function incrementListenCount(streamUrl) {
        if (!streamUrl) return;
        const counts = getListenCounts();
        counts[streamUrl] = (counts[streamUrl] || 0) + 1;
        localStorage.setItem('radioListenCounts', JSON.stringify(counts));
        if (activeGroupName === 'En Ã‡ok Dinlenenler') {
            listChannels(activeGroupName);
        }
    }
    function toggleFavorite(streamUrl, favButton) {
        let favorites = getFavorites();
        const index = favorites.indexOf(streamUrl);
        const wasEmpty = favorites.length === 0;
        const wasOnFavoritesTab = (activeGroupName === 'Favorilerim');
        if (index > -1) { 
            favorites.splice(index, 1); 
            favButton.classList.remove('favorited'); 
        } else { 
            favorites.push(streamUrl); 
            favButton.classList.add('favorited'); 
        }
        saveFavorites(favorites);
        const isEmptyNow = favorites.length === 0;
        if (wasEmpty !== isEmptyNow) { listGroups(); }
        if (wasOnFavoritesTab) { listChannels('Favorilerim'); }
    }

    // --- Kategori/Grup Listeleme (DeÄŸiÅŸiklik yok) ---
    function listGroups() {
      const currentActiveGroup = document.querySelector('.group.active')?.textContent || CATEGORIES[0];
      G_UI.groups.innerHTML = ""; 
      let groupToActivate = null;
      const favoritesCount = getFavorites().length;
      const listenCounts = getListenCounts();
      const mostListenedCount = Object.keys(listenCounts).length;
      
      CATEGORIES.forEach((g) => {
        if (g === 'Favorilerim' && favoritesCount === 0) return;
        if (g === 'En Ã‡ok Dinlenenler' && mostListenedCount === 0) return;
        
        const el = document.createElement("div"); el.className = "group"; el.textContent = g;
        el.onclick = () => { 
            document.querySelectorAll(".group.active").forEach(e => e.classList.remove("active")); 
            el.classList.add("active"); 
            activeGroupName = g; 
            listChannels(g); 
        };
        G_UI.groups.appendChild(el); 
        if (g === currentActiveGroup) groupToActivate = el;
      });
      
      if (groupToActivate) {
          groupToActivate.click();
      } else if (G_UI.groups.firstChild) {
          G_UI.groups.firstChild.click();
      }
    }

    // --- Kanal Listeleme (DeÄŸiÅŸiklik yok) ---
    function listChannels(group) {
      G_UI.channels.innerHTML = "";
      const favorites = getFavorites();
      
      if (group === 'Favorilerim') {
        currentChannelList = favorites.map(url => allChannelsMap.get(url)).filter(Boolean); 
      } 
      else if (group === 'En Ã‡ok Dinlenenler') {
        const listenCounts = getListenCounts();
        currentChannelList = Object.entries(listenCounts)
            .sort(([, countA], [, countB]) => countB - countA)
            .map(([url]) => allChannelsMap.get(url))
            .filter(Boolean)
            .slice(0, 20);
      }
      else {
        const categoryId = CATEGORIES.indexOf(group);
        currentChannelList = Array.from(allChannelsMap.values()).filter(c => c.categoryId === categoryId);
      }
      
      currentChannelList.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
      
      currentChannelList.forEach((c, idx) => {
        const isFavorited = favorites.includes(c.streamUrl);
        const el = document.createElement("div"); el.className = "channel";
        
        el.innerHTML = `
            <div class="channel-info">
                <img src="${c.logoUrl || ''}" onerror="this.style.display='none'" alt="logo">
                <div>
                    <div>${c.name}</div>
                </div>
            </div>
            <span class="fav-btn ${isFavorited ? 'favorited' : ''}">â˜…</span>
        `;
        
        const channelInfo = el.querySelector('.channel-info'), favButton = el.querySelector('.fav-btn');
        channelInfo.onclick = () => { 
            document.querySelectorAll(".channel.active").forEach(ch => ch.classList.remove("active")); 
            el.classList.add("active"); 
            playChannel(idx); 
        };
        favButton.onclick = (e) => { e.stopPropagation(); toggleFavorite(c.streamUrl, favButton); };
        G_UI.channels.appendChild(el);
      });
    }

    
    // --- OynatÄ±cÄ± FonksiyonlarÄ± (DeÄŸiÅŸiklik yok, HLS dÃ¼zeltmesi dahil) ---
    function stopStream(audioElement, hlsInstance) {
        audioElement.pause(); 
        audioElement.removeAttribute("src");
        try { audioElement.load(); } catch (e) {}
        
        if (hlsInstance) {
            hlsInstance.destroy();
            hls = null;
        }
        updatePlayerUI(false); 
    }

    async function playStream(audioElement, url) {
        stopStream(audioElement, hls); 
        
        const isHLS = url.includes('.m3u8');

        if (isHLS && Hls.isSupported()) { 
            console.log("HLS stream algÄ±landÄ±, Hls.js kullanÄ±lÄ±yor.");
            hls = new Hls(); 
            hls.loadSource(url); 
            hls.attachMedia(audioElement); 
        } 
        else { 
            console.log("DoÄŸrudan stream algÄ±landÄ± (MP3/Icecast), Hls.js kullanÄ±lmÄ±yor.");
            hls = null; 
            audioElement.src = url; 
        }
        
        audioElement.muted = false; audioElement.volume = 1.0;
        try { 
            await audioElement.play(); 
        } catch (err) { 
            console.error("Otomatik oynatma engellendi:", err); 
            updatePlayerUI(false);
        }
    }
    
    // Radyo kanalÄ± seÃ§me (DeÄŸiÅŸiklik yok)
    function playChannel(localIdx) {
        currentChannelIndex = localIdx; 
        const channel = currentChannelList[localIdx]; 
        if (!channel) return;
        
        incrementListenCount(channel.streamUrl);
        
        // Kayan YazÄ±yÄ± gÃ¼ncelle
        const scrollText = `${channel.name} - ${DEFAULT_SCROLL_TEXT}`;
        G_UI.player.channelName.innerHTML = `<span>${scrollText}</span><span>${scrollText}</span>`;
        
        // Ana ekranÄ± gÃ¼ncelle
        G_UI.preview.mainLogo.src = channel.logoUrl || '';
        
        // Kontrol butonlarÄ±nÄ± gÃ¶rÃ¼nÃ¼r yap
        G_UI.player.controls.forEach(btn => btn.style.visibility = 'visible');
        
        // Ses akÄ±ÅŸÄ±nÄ± baÅŸlat
        playStream(G_UI.audioPlayer, channel.streamUrl, true);
    }
    
    // ####################################################################
    // # --- DÃœZELTÄ°LMÄ°Å `updatePlayerUI` FONKSÄ°YONU ---
    // ####################################################################
    function updatePlayerUI(isPlaying) {
        // Player Ã§ubuÄŸu
        G_UI.player.container.classList.toggle('playing', isPlaying);
        G_UI.playIcon.classList.toggle('hidden', isPlaying);
        G_UI.pauseIcon.classList.toggle('hidden', !isPlaying);
        
        // Ana Ekran GÃ¶rÃ¼ntÃ¼sÃ¼
        G_UI.preview.area.classList.toggle('is-playing', isPlaying);
        
        // ***** DÃœZELTME: Kayan yazÄ± metnini sÄ±fÄ±rlayan BÃ–LÃœM KALDIRILDI *****
        // Kanal deÄŸiÅŸtirirken oluÅŸan "Radyo SeÃ§in" yazÄ±sÄ± hatasÄ±
        // bu sayede dÃ¼zeltildi.
    }
    
    // Sonraki/Ã–nceki Kanal (DeÄŸiÅŸiklik yok)
    function changeChannel(direction) {
        if (currentChannelList.length === 0 || currentChannelIndex < 0) return;
        const newIndex = (currentChannelIndex + direction + currentChannelList.length) % currentChannelList.length;
        const channelElements = G_UI.channels.querySelectorAll('.channel');
        
        if (channelElements[newIndex]) { 
            channelElements[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); 
            channelElements[newIndex].querySelector('.channel-info').click(); 
        }
    }

    // Ana Veri YÃ¼kleme Fonksiyonu (DeÄŸiÅŸiklik yok)
    async function fetchAndDisplayChannels() {
        try {
            const response = await fetch('./channels.txt?v=' + new Date().getTime()); 
            if (!response.ok) throw new Error(`HTTP hatasÄ±! Durum: ${response.status}`);
            
            const data = await response.text();
            const allChannels = data.trim().split('\n').map(line => {
                const [name, streamUrl, logoUrl, categoryIdStr] = line.split(',').map(item => item.trim());
                const categoryId = parseInt(categoryIdStr);
                return { name, streamUrl, logoUrl, categoryId };
            }).filter(ch => ch.name && ch.streamUrl && ch.logoUrl && !isNaN(ch.categoryId));

            allChannelsMap.clear();
            allChannels.forEach(channel => allChannelsMap.set(channel.streamUrl, channel));
            
            listGroups();
            
          } catch (error) {
            console.error('Kanal listesi (channels.txt) yÃ¼klenemedi:', error);
            const errorMsg = '<p style="padding: 10px; color: var(--text-secondary); font-size: 1.1em;">Kanal listesi (channels.txt) yÃ¼klenemedi...</p>';
            G_UI.channels.innerHTML = errorMsg;
            G_UI.preview.placeholder.innerHTML = `<h1>Hata</h1><p>channels.txt dosyasÄ± yÃ¼klenemedi.</p>`;
          }
    }
    
    // BaÄŸlantÄ± UyarÄ± Fonksiyonu (DeÄŸiÅŸiklik yok)
    function showConnectionWarning(isConnected) {
        const warningId = 'connection-warning-banner'; let warningEl = document.getElementById(warningId);
        if (isConnected) { if (warningEl) warningEl.remove(); } 
        else if (!warningEl) {
            warningEl = document.createElement('div'); warningEl.id = warningId;
            warningEl.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; background-color: #f44336; color: white; text-align: center; padding: 10px 0; font-weight: bold; z-index: 10000;`;
            warningEl.textContent = 'UYARI: Ä°nternet baÄŸlantÄ±sÄ± yok! Kanallar yÃ¼klenemeyebilir veya mevcut yayÄ±n durabilir.';
            document.body.prepend(warningEl);
        }
    }
    
    // --- BAÅLATMA ---
    window.addEventListener("load", async () => {
      // 1. TemalarÄ± ayarla
      createThemeSelector(); 
      applyTheme(localStorage.getItem('iptvTheme') || 'default');
      
      // KayÄ±tlÄ± Zoom ayarÄ±nÄ± yÃ¼kle
      loadSavedZoom();
      
      // 2. Profesyonel Ekolayzer BarlarÄ±nÄ± OluÅŸtur
      [G_UI.preview.mainAnalyzer1, G_UI.preview.mainAnalyzer2].forEach(analyzer => {
          for (let i = 0; i < 20; i++) {
              const bar = document.createElement('div');
              bar.classList.add('analyzer-bar');
              bar.style.animationDelay = `${Math.random() * -1.5}s`;
              bar.style.animationDuration = `${Math.random() * 1 + 0.5}s`;
              analyzer.appendChild(bar);
          }
      });
      
      // 3. OynatÄ±cÄ± olaylarÄ±nÄ± baÄŸla
      G_UI.playPauseBtn.addEventListener('click', () => {
          if (G_UI.audioPlayer.paused) {
              G_UI.audioPlayer.play().catch(e => console.error("Play hatasÄ±:", e));
          } else {
              G_UI.audioPlayer.pause();
          }
      });
      G_UI.audioPlayer.addEventListener('play', () => updatePlayerUI(true));
      G_UI.audioPlayer.addEventListener('pause', () => updatePlayerUI(false));
      G_UI.audioPlayer.addEventListener('ended', () => updatePlayerUI(false));

      // Zoom buton olaylarÄ±nÄ± baÄŸla
      G_UI.zoomInBtn.addEventListener('click', () => updateZoom(currentZoom + ZOOM_STEP));
      G_UI.zoomOutBtn.addEventListener('click', () => updateZoom(currentZoom - ZOOM_STEP));

      // 4. KanallarÄ± yÃ¼kle
      await fetchAndDisplayChannels();
      
      // 5. Ä°nternet baÄŸlantÄ± uyarÄ±sÄ±
      if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js').catch(err => console.error('SW kaydÄ± baÅŸarÄ±sÄ±z:', err)));
      if (!navigator.onLine) showConnectionWarning(false);
      window.addEventListener('online', () => showConnectionWarning(true));
      window.addEventListener('offline', () => showConnectionWarning(false));
      
      // 6. BaÅŸlangÄ±Ã§ kayan yazÄ± metnini ayarla
      const defaultText = `Radyo SeÃ§in - ${DEFAULT_SCROLL_TEXT}`;
      G_UI.player.channelName.innerHTML = `<span>${defaultText}</span><span>${defaultText}</span>`;
    });
  </script>
</body>
</html>
